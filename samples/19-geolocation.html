<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>19 - ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã¨ç¾åœ¨åœ°è¡¨ç¤º</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .description {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #map {
            height: 500px;
            width: 100%;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .controls button {
            padding: 10px 20px;
            font-size: 14px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
            transition: background 0.3s;
        }
        .controls button:hover {
            background: #0056b3;
        }
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status-panel {
            margin-top: 15px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
        }
        .code-section {
            margin-top: 20px;
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .code-section pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .locate-button {
            width: 34px;
            height: 34px;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
        }
        .locate-button:hover {
            background: #f4f4f4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>19 - ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã¨ç¾åœ¨åœ°è¡¨ç¤º</h1>
        <div class="description">
            <p><strong>å­¦ç¿’å†…å®¹:</strong> ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±APIã‚’ä½¿ç”¨ã—ã¦ç¾åœ¨åœ°ã‚’åœ°å›³ä¸Šã«è¡¨ç¤ºã—ã¾ã™ã€‚</p>
            <p><strong>ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>map.locate() ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±ã‚’å–å¾—</li>
                <li>locationfound ã‚¤ãƒ™ãƒ³ãƒˆã§ä½ç½®å–å¾—æˆåŠŸæ™‚ã®å‡¦ç†</li>
                <li>locationerror ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚¨ãƒ©ãƒ¼å‡¦ç†</li>
                <li>setView: true ã§è‡ªå‹•çš„ã«ãã®ä½ç½®ã«ç§»å‹•</li>
            </ul>
            <p><strong>æ³¨æ„:</strong></p>
            <ul>
                <li>ãƒ–ãƒ©ã‚¦ã‚¶ã§ä½ç½®æƒ…å ±ã®è¨±å¯ãŒå¿…è¦ã§ã™</li>
                <li><strong>HTTPSæ¥ç¶šã¾ãŸã¯localhost</strong>ã§ã®ã¿å‹•ä½œã—ã¾ã™ï¼ˆhttp://ã‚„file://ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ï¼‰</li>
            </ul>
        </div>

        <div id="map"></div>

        <div class="controls">
            <button onclick="locateMe()" id="locateBtn">ç¾åœ¨åœ°ã‚’å–å¾—</button>
            <button onclick="watchPosition()" id="watchBtn">ä½ç½®ã‚’è¿½è·¡</button>
            <button onclick="stopWatch()" id="stopBtn" disabled>è¿½è·¡ã‚’åœæ­¢</button>
        </div>

        <div class="status-panel">
            <div id="status">ä½ç½®æƒ…å ±: æœªå–å¾—</div>
            <div id="accuracy"></div>
        </div>

        <div class="code-section">
            <pre>
// ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ç§»å‹•
map.locate({
    setView: true,
    maxZoom: 16
});

// ä½ç½®å–å¾—æˆåŠŸæ™‚
map.on('locationfound', function(e) {
    const radius = e.accuracy / 2;

    L.marker(e.latlng)
        .addTo(map)
        .bindPopup(`ç¾åœ¨åœ°ï¼ˆç²¾åº¦: ${radius}mï¼‰`);

    L.circle(e.latlng, {
        radius: radius
    }).addTo(map);
});

// ä½ç½®å–å¾—å¤±æ•—æ™‚
map.on('locationerror', function(e) {
    alert('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ: ' + e.message);
});
            </pre>
        </div>
    </div>

    <!-- Leaflet.jsæœ¬ä½“ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ========================================
        // ç¾åœ¨åœ°è¡¨ç¤ºï¼ˆGeolocationï¼‰ã®ã‚µãƒ³ãƒ—ãƒ«
        // ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±APIã‚’ä½¿ç”¨
        // ========================================

        // åœ°å›³ã‚’åˆæœŸåŒ–
        const map = L.map('map').setView([35.6812, 139.7671], 13);

        // ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // ä½ç½®æƒ…å ±é–¢é€£ã®å¤‰æ•°
        let locationMarker = null;   // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
        let locationCircle = null;   // ç²¾åº¦ã‚’ç¤ºã™å††
        let watchId = null;          // è¿½è·¡ç”¨ã®ID

        // ----------------------------------------
        // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³
        // ----------------------------------------
        const locationIcon = L.divIcon({
            className: '',
            html: `<div style="
                width: 20px;
                height: 20px;
                background: #4285f4;
                border: 3px solid white;
                border-radius: 50%;
                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            "></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });

        // ä½ç½®æƒ…å ±ã®æ›´æ–°
        function updateLocation(e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);
            const accuracy = e.accuracy;

            // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã¨å††ã‚’å‰Šé™¤
            if (locationMarker) {
                map.removeLayer(locationMarker);
            }
            if (locationCircle) {
                map.removeLayer(locationCircle);
            }

            // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã¨å††ã‚’è¿½åŠ 
            locationMarker = L.marker(e.latlng, { icon: locationIcon })
                .addTo(map)
                .bindPopup(`
                    <b>ç¾åœ¨åœ°</b><br>
                    ç·¯åº¦: ${lat}<br>
                    çµŒåº¦: ${lng}<br>
                    ç²¾åº¦: ${accuracy.toFixed(0)}m
                `);

            locationCircle = L.circle(e.latlng, {
                radius: accuracy,
                color: '#4285f4',
                fillColor: '#4285f4',
                fillOpacity: 0.15,
                weight: 2
            }).addTo(map);

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.getElementById('status').innerHTML =
                `ä½ç½®æƒ…å ±: ç·¯åº¦ ${lat}, çµŒåº¦ ${lng}`;
            document.getElementById('accuracy').innerHTML =
                `ç²¾åº¦: ç´„ ${accuracy.toFixed(0)}m`;
        }

        // ----------------------------------------
        // ä½ç½®æƒ…å ±ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        // ----------------------------------------

        // ä½ç½®å–å¾—æˆåŠŸæ™‚: locationfound ã‚¤ãƒ™ãƒ³ãƒˆ
        // e.latlng: ä½ç½®åº§æ¨™
        // e.accuracy: ç²¾åº¦ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰
        map.on('locationfound', function(e) {
            updateLocation(e);
        });

        // ä½ç½®å–å¾—å¤±æ•—æ™‚: locationerror ã‚¤ãƒ™ãƒ³ãƒˆ
        // ã‚ˆãã‚ã‚‹åŸå› : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨±å¯ã—ãªã‹ã£ãŸã€HTTPSã§ãªã„ã€ãªã©
        map.on('locationerror', function(e) {
            document.getElementById('status').innerHTML =
                `ã‚¨ãƒ©ãƒ¼: ${e.message}`;
            document.getElementById('accuracy').innerHTML = '';
            alert('ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        });

        // ----------------------------------------
        // map.locate() ã§ç¾åœ¨åœ°ã‚’å–å¾—
        // ----------------------------------------
        function locateMe() {
            document.getElementById('status').innerHTML = 'ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...';
            document.getElementById('locateBtn').disabled = true;

            // locate() ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
            map.locate({
                setView: true,           // å–å¾—ã—ãŸä½ç½®ã«è‡ªå‹•ç§»å‹•
                maxZoom: 16,             // è‡ªå‹•ç§»å‹•æ™‚ã®æœ€å¤§ã‚ºãƒ¼ãƒ 
                enableHighAccuracy: true // é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ï¼ˆGPSä½¿ç”¨ï¼‰
            });

            setTimeout(() => {
                document.getElementById('locateBtn').disabled = false;
            }, 1000);
        }

        // ----------------------------------------
        // ä½ç½®ã‚’ç¶™ç¶šçš„ã«è¿½è·¡
        // ----------------------------------------
        // watch: true ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¿½è·¡
        function watchPosition() {
            document.getElementById('status').innerHTML = 'ä½ç½®ã‚’è¿½è·¡ä¸­...';
            document.getElementById('watchBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;

            map.locate({
                watch: true,             // ç¶™ç¶šçš„ã«ä½ç½®ã‚’è¿½è·¡
                setView: true,
                maxZoom: 16,
                enableHighAccuracy: true
            });
        }

        // ----------------------------------------
        // è¿½è·¡ã‚’åœæ­¢
        // ----------------------------------------
        function stopWatch() {
            // stopLocate() ã§è¿½è·¡ã‚’åœæ­¢
            map.stopLocate();
            document.getElementById('watchBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').innerHTML += ' (è¿½è·¡åœæ­¢)';
        }

        // ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ã—ã¦è¿½åŠ 
        const LocateControl = L.Control.extend({
            options: {
                position: 'topleft'
            },
            onAdd: function(map) {
                const container = L.DomUtil.create('div', '');
                const button = L.DomUtil.create('button', 'locate-button', container);
                button.innerHTML = 'ğŸ“';
                button.title = 'ç¾åœ¨åœ°ã‚’å–å¾—';

                L.DomEvent.on(button, 'click', function(e) {
                    L.DomEvent.stopPropagation(e);
                    locateMe();
                });

                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });
        new LocateControl().addTo(map);

        // ãƒ‡ãƒ¢ç”¨: ä½ç½®æƒ…å ±ãŒä½¿ãˆãªã„ç’°å¢ƒç”¨ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
        L.marker([35.6812, 139.7671])
            .addTo(map)
            .bindPopup('ãƒ‡ãƒ¢ä½ç½®ï¼ˆæ±äº¬é§…ï¼‰<br>å®Ÿéš›ã®ç¾åœ¨åœ°ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
    </script>
</body>
</html>
