<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>22 - ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ä½œæˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .description {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #map {
            height: 550px;
            width: 100%;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .search-control {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .search-control input {
            width: 200px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .search-control button {
            padding: 5px 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-left: 5px;
        }
        .toolbar-control {
            background: white;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .toolbar-control button {
            display: block;
            width: 36px;
            height: 36px;
            border: none;
            background: white;
            cursor: pointer;
            font-size: 18px;
            border-bottom: 1px solid #eee;
        }
        .toolbar-control button:hover {
            background: #f4f4f4;
        }
        .toolbar-control button:last-child {
            border-bottom: none;
        }
        .toolbar-control button.active {
            background: #e3f2fd;
        }
        .minimap-control {
            background: white;
            padding: 3px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }
        .minimap-control #minimap {
            width: 150px;
            height: 100px;
            border-radius: 3px;
        }
        .stats-control {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
            font-size: 12px;
        }
        .stats-control h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }
        .code-section {
            margin-top: 20px;
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .code-section pre {
            margin: 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>22 - ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ä½œæˆ</h1>
        <div class="description">
            <p><strong>å­¦ç¿’å†…å®¹:</strong> L.Controlã‚’æ‹¡å¼µã—ã¦ç‹¬è‡ªã®UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
            <p><strong>ãƒã‚¤ãƒ³ãƒˆ:</strong></p>
            <ul>
                <li>L.Control.extend() ã§ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ</li>
                <li>onAdd() ã§DOMè¦ç´ ã‚’è¿”ã™</li>
                <li>onRemove() ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†</li>
                <li>L.DomEvent ã§ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†</li>
            </ul>
            <p><strong>é‡è¦:</strong> ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«å†…ã®æ“ä½œãŒåœ°å›³ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã€<code>disableClickPropagation()</code> ã¨ <code>disableScrollPropagation()</code> ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
        </div>

        <div id="map"></div>

        <div class="code-section">
            <pre>
// ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å®šç¾©
const MyControl = L.Control.extend({
    options: {
        position: 'topright'
    },

    onAdd: function(map) {
        // ã‚³ãƒ³ãƒ†ãƒŠDOMè¦ç´ ã‚’ä½œæˆ
        const container = L.DomUtil.create('div', 'my-control');

        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’åœæ­¢
        L.DomEvent.disableClickPropagation(container);

        // ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        const button = L.DomUtil.create('button', '', container);
        button.innerHTML = 'Click me';

        L.DomEvent.on(button, 'click', function() {
            alert('Button clicked!');
        });

        return container;
    },

    onRemove: function(map) {
        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†
    }
});

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
new MyControl().addTo(map);
            </pre>
        </div>
    </div>

    <!-- Leaflet.jsæœ¬ä½“ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ========================================
        // ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä½œæˆã®ã‚µãƒ³ãƒ—ãƒ«
        // L.Control.extend() ã‚’ä½¿ã£ã¦ç‹¬è‡ªã®UIã‚’ä½œæˆ
        // ========================================

        // ----------------------------------------
        // åœ°å›³ã‚’åˆæœŸåŒ–
        // ----------------------------------------
        const map = L.map('map').setView([35.6812, 139.7671], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // ----------------------------------------
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
        // ----------------------------------------
        const markers = [];
        const locations = [
            { name: 'æ±äº¬é§…', lat: 35.6812, lng: 139.7671 },
            { name: 'æ–°å®¿é§…', lat: 35.6896, lng: 139.7006 },
            { name: 'æ¸‹è°·é§…', lat: 35.6580, lng: 139.7016 }
        ];

        locations.forEach(loc => {
            const m = L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(loc.name);
            markers.push(m);
        });

        // ========================================
        // 1. æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        // ========================================
        // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã¨ãƒœã‚¿ãƒ³ã‚’æŒã¤æ¤œç´¢UI
        // L.Control.extend() ã§Leafletã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹ã‚’æ‹¡å¼µ
        const SearchControl = L.Control.extend({
            // options: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®è¨­å®š
            // position: é…ç½®ä½ç½®ï¼ˆtopleft, topright, bottomleft, bottomrightï¼‰
            options: { position: 'topleft' },

            // onAdd: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãŒåœ°å›³ã«è¿½åŠ ã•ã‚ŒãŸã¨ãã«å‘¼ã°ã‚Œã‚‹
            // å¿…ãšDOMè¦ç´ ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚‹
            onAdd: function(map) {
                // L.DomUtil.create(ã‚¿ã‚°å, CSSã‚¯ãƒ©ã‚¹, è¦ªè¦ç´ ) ã§DOMè¦ç´ ã‚’ä½œæˆ
                const container = L.DomUtil.create('div', 'search-control');

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆ
                const input = L.DomUtil.create('input', '', container);
                input.type = 'text';
                input.placeholder = 'å ´æ‰€ã‚’æ¤œç´¢...';
                input.id = 'searchInput';

                // ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
                const button = L.DomUtil.create('button', '', container);
                button.innerHTML = 'æ¤œç´¢';

                // é‡è¦: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä¸Šã®ã‚¯ãƒªãƒƒã‚¯ãŒåœ°å›³ã«ä¼æ’­ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
                // ã“ã‚ŒãŒãªã„ã¨ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«åœ°å›³ã‚‚ã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¦ã—ã¾ã†
                L.DomEvent.disableClickPropagation(container);

                // L.DomEvent.on() ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²
                L.DomEvent.on(button, 'click', function() {
                    const query = document.getElementById('searchInput').value.toLowerCase();
                    const found = locations.find(l => l.name.includes(query));
                    if (found) {
                        map.setView([found.lat, found.lng], 15);
                        markers.find(m => m.getLatLng().lat === found.lat).openPopup();
                    } else {
                        alert('å ´æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                });

                return container;
            }
        });

        // new ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã¦ addTo() ã§åœ°å›³ã«è¿½åŠ 
        new SearchControl().addTo(map);

        // ========================================
        // 2. ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        // ========================================
        // è¤‡æ•°ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’ç¸¦ã«ä¸¦ã¹ãŸãƒ„ãƒ¼ãƒ«ãƒãƒ¼
        const ToolbarControl = L.Control.extend({
            options: { position: 'topleft' },

            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'toolbar-control');

                // ----------------------------------------
                // ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³: åˆæœŸä½ç½®ã«æˆ»ã‚‹
                // ----------------------------------------
                const homeBtn = L.DomUtil.create('button', '', container);
                homeBtn.innerHTML = 'ğŸ ';
                homeBtn.title = 'åˆæœŸä½ç½®ã«æˆ»ã‚‹';
                L.DomEvent.on(homeBtn, 'click', function(e) {
                    // L.DomEvent.stop() ã§ã‚¤ãƒ™ãƒ³ãƒˆã®ä¼æ’­ã‚’å®Œå…¨ã«åœæ­¢
                    L.DomEvent.stop(e);
                    map.setView([35.6812, 139.7671], 13);
                });

                // ----------------------------------------
                // å…¨ä½“è¡¨ç¤ºãƒœã‚¿ãƒ³: å…¨ãƒãƒ¼ã‚«ãƒ¼ãŒè¦‹ãˆã‚‹ç¯„å›²ã«ãƒ•ã‚£ãƒƒãƒˆ
                // ----------------------------------------
                const fitBtn = L.DomUtil.create('button', '', container);
                fitBtn.innerHTML = 'ğŸ”²';
                fitBtn.title = 'å…¨ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º';
                L.DomEvent.on(fitBtn, 'click', function(e) {
                    L.DomEvent.stop(e);
                    // featureGroup ã‚’ä½œæˆã—ã¦ getBounds() ã§å¢ƒç•Œã‚’å–å¾—
                    const group = L.featureGroup(markers);
                    // pad(0.2) ã§20%ã®ä½™ç™½ã‚’è¿½åŠ 
                    map.fitBounds(group.getBounds().pad(0.2));
                });

                // ----------------------------------------
                // ä½ç½®æƒ…å ±ãƒœã‚¿ãƒ³: ç¾åœ¨åœ°ã‚’å–å¾—
                // ----------------------------------------
                const locateBtn = L.DomUtil.create('button', '', container);
                locateBtn.innerHTML = 'ğŸ“';
                locateBtn.title = 'ç¾åœ¨åœ°ã‚’å–å¾—';
                L.DomEvent.on(locateBtn, 'click', function(e) {
                    L.DomEvent.stop(e);
                    // map.locate() ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®ä½ç½®æƒ…å ±ã‚’å–å¾—
                    map.locate({ setView: true, maxZoom: 16 });
                });

                // ----------------------------------------
                // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒœã‚¿ãƒ³
                // ----------------------------------------
                const fullscreenBtn = L.DomUtil.create('button', '', container);
                fullscreenBtn.innerHTML = 'â›¶';
                fullscreenBtn.title = 'ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³';
                L.DomEvent.on(fullscreenBtn, 'click', function(e) {
                    L.DomEvent.stop(e);
                    // Fullscreen API ã‚’ä½¿ç”¨
                    const mapContainer = map.getContainer();
                    if (!document.fullscreenElement) {
                        mapContainer.requestFullscreen();
                    } else {
                        document.exitFullscreen();
                    }
                });

                L.DomEvent.disableClickPropagation(container);
                return container;
            }
        });

        new ToolbarControl().addTo(map);

        // ========================================
        // 3. ãƒŸãƒ‹ãƒãƒƒãƒ—ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        // ========================================
        // ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ—ã®æ¦‚è¦ã‚’è¡¨ç¤ºã™ã‚‹å°ã•ãªåœ°å›³
        // ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ—ã®ç§»å‹•ã«è¿½å¾“ã™ã‚‹
        const MinimapControl = L.Control.extend({
            options: { position: 'bottomright' },

            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'minimap-control');
                const minimapDiv = L.DomUtil.create('div', '', container);
                minimapDiv.id = 'minimap';

                // ã‚¯ãƒªãƒƒã‚¯ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ä¼æ’­ã‚’ç„¡åŠ¹åŒ–
                L.DomEvent.disableClickPropagation(container);
                L.DomEvent.disableScrollPropagation(container);

                // setTimeout ã§é…å»¶å®Ÿè¡Œï¼ˆDOMè¦ç´ ãŒæº–å‚™ã§ãã¦ã‹ã‚‰åˆæœŸåŒ–ï¼‰
                setTimeout(() => {
                    // ãƒŸãƒ‹ãƒãƒƒãƒ—ç”¨ã®åœ°å›³ã‚’åˆæœŸåŒ–
                    // ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ã«
                    const minimap = L.map('minimap', {
                        zoomControl: false,          // ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³éè¡¨ç¤º
                        attributionControl: false,   // è‘—ä½œæ¨©è¡¨ç¤ºéè¡¨ç¤º
                        dragging: false,             // ãƒ‰ãƒ©ãƒƒã‚°ç„¡åŠ¹
                        scrollWheelZoom: false       // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚ºãƒ¼ãƒ ç„¡åŠ¹
                    }).setView(map.getCenter(), map.getZoom() - 4);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(minimap);

                    // è¡¨ç¤ºç¯„å›²ã‚’ç¤ºã™çŸ©å½¢
                    const bounds = map.getBounds();
                    const rect = L.rectangle(bounds, { color: '#ff0000', weight: 2, fill: false }).addTo(minimap);

                    // ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒ—ã®ç§»å‹•ã«è¿½å¾“
                    map.on('move', function() {
                        minimap.setView(map.getCenter(), map.getZoom() - 4);
                        rect.setBounds(map.getBounds());
                    });
                }, 100);

                return container;
            }
        });

        new MinimapControl().addTo(map);

        // ========================================
        // 4. çµ±è¨ˆæƒ…å ±ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
        // ========================================
        // åœ°å›³ã®çŠ¶æ…‹ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤º
        // ç§»å‹•ã‚„ã‚ºãƒ¼ãƒ æ™‚ã«è‡ªå‹•æ›´æ–°
        const StatsControl = L.Control.extend({
            options: { position: 'bottomleft' },

            onAdd: function(map) {
                const container = L.DomUtil.create('div', 'stats-control');
                container.id = 'statsPanel';
                this.updateStats(container, map);

                // moveend, zoomend ã‚¤ãƒ™ãƒ³ãƒˆã§çµ±è¨ˆã‚’æ›´æ–°
                // ã‚¢ãƒ­ãƒ¼é–¢æ•°ã‚’ä½¿ã†ã“ã¨ã§ this ã‚’ä¿æŒ
                map.on('moveend zoomend', () => this.updateStats(container, map));

                L.DomEvent.disableClickPropagation(container);
                return container;
            },

            // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰
            updateStats: function(container, map) {
                const center = map.getCenter();
                const bounds = map.getBounds();
                // ç¾åœ¨ã®è¡¨ç¤ºç¯„å›²å†…ã«ã‚ã‚‹ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                const visibleMarkers = markers.filter(m => bounds.contains(m.getLatLng())).length;

                container.innerHTML = `
                    <h4>åœ°å›³æƒ…å ±</h4>
                    <div>ã‚ºãƒ¼ãƒ : ${map.getZoom()}</div>
                    <div>ä¸­å¿ƒ: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}</div>
                    <div>è¡¨ç¤ºä¸­ã®ãƒãƒ¼ã‚«ãƒ¼: ${visibleMarkers}/${markers.length}</div>
                `;
            }
        });

        new StatsControl().addTo(map);

        // ãƒ’ãƒ³ãƒˆ: ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ä½œæˆã®ãƒã‚¤ãƒ³ãƒˆ
        // 1. L.Control.extend() ã§æ–°ã—ã„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©
        // 2. onAdd() ã§DOMè¦ç´ ã‚’ä½œæˆã—ã¦è¿”ã™
        // 3. L.DomEvent.disableClickPropagation() ã§ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’é˜²æ­¢
        // 4. onRemove() ã§ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®å‰Šé™¤ãªã©ï¼‰
    </script>
</body>
</html>
